name: GoZen Windows release build
on:
  workflow_dispatch:
    inputs:
      version:
        description: GoZen version number
        type: string
        default: '0.5.1-alpha'
      godot_version:
        description: The Godot version to use
        type: string
        default: '4.5.1-stable'

env:
  APP_NAME: gozen
  PATH_FFMPEG: core/ffmpeg/bin_windows
  PATH_EXPORT: bin/windows_x86_64

run-name: 'Build GoZen Windows Release: v${{ inputs.version }} by @${{ github.actor }}'

jobs:
# Start FFMPEG build
  ffmpeg-build-deps:
    name: FFmpeg - Windows dependency ${{ matrix.dep }}
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        dep: [x264, x265, aom, svt_av1, vpx, opus, ogg_vorbis, mp3lame]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-windows-build-env

      - name: Build ${{ matrix.dep }}
        uses: ./.github/actions/build-ffmpeg-dep
        with:
          dep_name: ${{ matrix.dep }}
          arch: x86_64

      - uses: actions/upload-artifact@v4
        with:
          name: dep_win_x86_64_${{ matrix.dep }}
          path: ${{ env.PATH_FFMPEG }}
          retention-days: 1

  ffmpeg-compile-x86_64:
    name: Compile FFmpeg - Windows x86_64
    needs: ffmpeg-build-deps
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-windows-build-env

      - name: Download all dependencies
        uses: actions/download-artifact@v4
        with:
          pattern: dep_win_x86_64_*
          path: ${{ env.PATH_FFMPEG }}
          merge-multiple: true

      - name: Compile FFmpeg
        working-directory: ./core
        run: python3 -c "import sys; sys.path.append('.'); import build_ffmpeg; build_ffmpeg.build_ffmpeg_windows('x86_64', 4, {})"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg_windows_x86_64
          path: ${{ env.PATH_FFMPEG }}
          retention-days: 1
# End FFMPEG

# Start GDExtension
  build-gde:
    name: Build Windows GDE (${{ matrix.target }})
    runs-on: windows-latest
    needs: ffmpeg-compile-x86_64
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: template_debug
          - target: template_release
    steps:
      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setting up environment.
      - name: Setup Windows dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-scons mingw-w64-ucrt-x86_64-python make

      # Download FFmpeg.
      - name: Download FFmpeg
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg_windows_x86_64
          path: ${{ env.PATH_FFMPEG }}

      # Compile.
      - name: Compile GDE
        working-directory: ./core
        run: scons -j$(nproc) target=${{ matrix.target }} platform=windows arch=x86_64 use_static_cpp=yes use_mingw=yes
        
      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_gde_${{ matrix.target }}_x86_64
          path: ${{ env.PATH_EXPORT }}
          retention-days: 1
# End GDExtension

# Start GoZen build
  export-gozen:
    name: Export Windows
    needs: build-gde
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git zip unzip mingw-w64-ucrt-x86_64-gcc

      - name: Download rcedit
        shell: bash
        run: |
          curl -L -o rcedit.exe https://github.com/electron/rcedit/releases/download/v2.0.0/rcedit-x64.exe
          mkdir -p /c/Program\ Files/Godot
          mv rcedit.exe /c/Program\ Files/Godot/rcedit.exe

      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ inputs.godot_version }}
          os: windows

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_debug_x86_64
          path: ${{ env.PATH_EXPORT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_release_x86_64
          path: ${{ env.PATH_EXPORT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Copy MinGW runtime DLLs
        run: |
          cp /ucrt64/bin/libgcc_s_seh-1.dll ${{ env.PATH_EXPORT }}/
          cp /ucrt64/bin/libstdc++-6.dll ${{ env.PATH_EXPORT }}/
          cp /ucrt64/bin/libwinpthread-1.dll ${{ env.PATH_EXPORT }}/

      - name: Configure Godot rcedit path
        shell: bash
        run: |
          export PATH=$PATH:"/c/Program Files/Godot"
          godot --headless --quit
          echo 'export/windows/rcedit = "C:/Program Files/Godot/rcedit.exe"' >> src/export_presets.cfg

      - name: Export Windows
        working-directory: ./src
        run: |
          export PATH=$PATH:"/c/Program Files/Godot":"$(pwd)/../${{ env.PATH_EXPORT }}"
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot
          mkdir -p ../${{ env.PATH_EXPORT }}
          godot --import godot.project --headless --quit
          godot --headless --export-release "Windows_x86_64" ../${{ env.PATH_EXPORT }}/GoZen.exe

      - name: Bundle Windows
        working-directory: ${{ env.PATH_EXPORT }}
        run: |
          cp ../../LICENSE .
          cp ../../MANUAL.md .
          zip -r "GoZen_Windows_v${{ inputs.version }}.zip" *

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_Windows_v${{ inputs.version }}
          path: ${{ env.PATH_EXPORT }}/GoZen_Windows_v${{ inputs.version }}.zip 
# End GoZen build
