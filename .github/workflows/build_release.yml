name: Build GoZen release
on:
  workflow_dispatch:
    inputs:
      version:
        description: Version number
        type: string
        default: '0.0.0'

env:
  GODOT_VERSION: ${{ vars.GODOT_VERSION }}
  APP_NAME: gozen
  EXPORT_PATH_LINUX: bin/linux_x86_64
  EXPORT_PATH_WINDOWS: bin/windows_x86_64

run-name: 'Build GoZen Release: v${{ inputs.version }} by @${{ github.actor }}'

jobs:
  prepare:
    name: Locate artifacts
    runs-on: ubuntu-22.04
    outputs:
      gde_run_id: ${{ steps.find-gde.outputs.run_id }}
    steps:
      - name: Find latest GDE run
        id: find-gde
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WORKFLOW_NAME="Compile GDE GoZen"
          
          echo "Searching for latest successful run of: $WORKFLOW_NAME"
          LATEST_ID=$(gh run list --repo ${{ github.repository }} --workflow "$WORKFLOW_NAME" --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          
          if [ -z "$LATEST_ID" ]; then
            echo "::error::Could not find a successful run for workflow '$WORKFLOW_NAME'."
            exit 1
          fi
          
          echo "Found Run ID: $LATEST_ID"
          echo "run_id=$LATEST_ID" >> $GITHUB_OUTPUT

  export-linux:
    name: Export linux
    needs: prepare
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-linux-deps
      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ env.GODOT_VERSION }}
          os: linux

      - name: Setup FFmpeg
        uses: ./.github/actions/setup-ffmpeg
        with:
          os: linux
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_debug_x86_64
          path: ${{ env.EXPORT_PATH_LINUX }}
          run-id: ${{ needs.prepare.outputs.gde_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_release_x86_64
          path: ${{ env.EXPORT_PATH_LINUX }}
          run-id: ${{ needs.prepare.outputs.gde_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare & export
        working-directory: ./src
        run: |
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot

          mkdir -p ../${{ env.EXPORT_PATH_LINUX }}
          export LD_LIBRARY_PATH=$(readlink -f ../${{ env.EXPORT_PATH_LINUX }}):$LD_LIBRARY_PATH
          ls -l ../${{ env.EXPORT_PATH_LINUX }}

          godot --import godot.project --headless --quit
          godot --headless --export-release "Linux_x86_64" ../${{ env.EXPORT_PATH_LINUX }}/${{ env.APP_NAME }}.x86_64

      - name: Cleanup & fix RPATH
        working-directory: ${{ env.EXPORT_PATH_LINUX }}
        run: |
          rm -f *template_debug* 
          chmod +x ${{ env.APP_NAME }}.x86_64
          patchelf --set-rpath '$ORIGIN' ${{ env.APP_NAME }}.x86_64
          find . -name "*.so" -exec patchelf --set-rpath '$ORIGIN' {} \;

      - name: Upload raw Linux export
        uses: actions/upload-artifact@v4
        with:
          name: export_linux
          path: ${{ env.EXPORT_PATH_LINUX }}

  export-windows:
    name: Export Windows
    needs: prepare
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git zip unzip mingw-w64-ucrt-x86_64-gcc

      - name: Download rcedit
        shell: bash
        run: |
          curl -L -o rcedit.exe https://github.com/electron/rcedit/releases/download/v2.0.0/rcedit-x64.exe
          mkdir -p /c/Program\ Files/Godot
          mv rcedit.exe /c/Program\ Files/Godot/rcedit.exe

      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ env.GODOT_VERSION }}
          os: windows

      - name: Setup FFmpeg
        uses: ./.github/actions/setup-ffmpeg
        with:
          os: windows
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_debug_x86_64
          path: ${{ env.EXPORT_PATH_WINDOWS }}
          run-id: ${{ needs.prepare.outputs.gde_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_release_x86_64
          path: ${{ env.EXPORT_PATH_WINDOWS }}
          run-id: ${{ needs.prepare.outputs.gde_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Godot rcedit path
        shell: bash
        run: |
          export PATH=$PATH:"/c/Program Files/Godot"
          godot --headless --quit
          echo 'export/windows/rcedit = "C:/Program Files/Godot/rcedit.exe"' >> src/export_presets.cfg

      - name: Export Windows
        working-directory: ./src
        run: |
          export PATH=$PATH:"/c/Program Files/Godot":"$(pwd)/../${{ env.EXPORT_PATH_WINDOWS }}"
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot
          mkdir -p ../${{ env.EXPORT_PATH_WINDOWS }}
          godot --import godot.project --headless --quit
          godot --headless --export-release "Windows_x86_64" ../${{ env.EXPORT_PATH_WINDOWS }}/GoZen.exe

      - name: Bundle Windows
        working-directory: ${{ env.EXPORT_PATH_WINDOWS }}
        run: |
          cp ../../LICENSE .
          cp ../../MANUAL.md .
          zip -r "GoZen_Windows_v${{ inputs.version }}.zip" *

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_Windows_v${{ inputs.version }}
          path: ${{ env.EXPORT_PATH_WINDOWS }}/GoZen_Windows_v${{ inputs.version }}.zip 
        
  package-appimage:
    name: Package AppImage
    needs: export-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin

      - name: Build AppImage
        run: |
          APP_DIR=AppDir
          mkdir -p $APP_DIR/usr/{bin,lib,share/applications,share/icons/hicolor/128x128/apps}
          
          # Copy Binary & Libs
          cp bin/${{ env.APP_NAME }}.x86_64 $APP_DIR/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $APP_DIR/usr/lib/
          
          # Copy Assets
          cp assets/linux/gozen.png $APP_DIR/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png
          cp assets/linux/gozen.png $APP_DIR/.DirIcon
          cp assets/linux/gozen.desktop $APP_DIR/usr/share/applications/
          
          # Create AppRun
          cat <<EOF > $APP_DIR/AppRun
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\${0}")")"
          export LD_LIBRARY_PATH="\$HERE/usr/lib:\$LD_LIBRARY_PATH"
          exec "\$HERE/usr/bin/${{ env.APP_NAME }}" "\$@"
          EOF
          chmod +x $APP_DIR/AppRun $APP_DIR/usr/bin/${{ env.APP_NAME }}

          # Download LinuxDeploy & Build
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          ./linuxdeploy-x86_64.AppImage --appdir $APP_DIR --output appimage

          # Rename
          mv GoZen*.AppImage ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_AppImage_v${{ inputs.version }}
          path: ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

  package-deb:
    name: Package DEB
    needs: export-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin
      
      - name: Build DEB
        run: |
          DEB_ROOT=deb_dist
          mkdir -p $DEB_ROOT/{DEBIAN,usr/bin,usr/lib/${{ env.APP_NAME }},usr/share/applications,usr/share/icons/hicolor/128x128/apps}

          cp bin/${{ env.APP_NAME }}.x86_64 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $DEB_ROOT/usr/lib/${{ env.APP_NAME }}/
          cp assets/linux/gozen.desktop $DEB_ROOT/usr/share/applications/
          cp assets/linux/gozen.png $DEB_ROOT/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png

          chmod 755 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}

          cat <<EOF > $DEB_ROOT/DEBIAN/control
          Package: ${{ env.APP_NAME }}
          Version: ${{ inputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.27)
          Maintainer: Voylin <noreply@example.com>
          Description: GoZen Video Editor
           A fast and modern open-source video editor for Linux.
          EOF

          dpkg-deb --build $DEB_ROOT ${{ env.APP_NAME }}_v${{ inputs.version }}_amd64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_DEB_v${{ inputs.version }}
          path: "*.deb"

  package-rpm:
    name: Package RPM
    needs: export-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin
      
      - name: Install RPM tools
        run: sudo apt-get install -y rpm

      - name: Build RPM
        run: |
          VERSION=$(echo "${{ inputs.version }}" | tr '-' '_')
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          SRC_DIR=rpmbuild/SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}
          mkdir -p $SRC_DIR
          cp bin/* $SRC_DIR/
          cp assets/linux/gozen.desktop $SRC_DIR/
          cp assets/linux/gozen.png $SRC_DIR/
          
          sed -i 's|^Exec=.*|Exec=/opt/${{ env.APP_NAME }}/${{ env.APP_NAME }}.x86_64|' $SRC_DIR/gozen.desktop

          cat <<EOF > rpmbuild/SPECS/${{ env.APP_NAME }}.spec
          %define _topdir $(pwd)/rpmbuild
          Name:           ${{ env.APP_NAME }}
          Version:        $VERSION
          Release:        1
          Summary:        GoZen Video Editor
          License:        GPLv3
          BuildArch:      x86_64
          
          %description
          GoZen Video Editor.

          %install
          mkdir -p %{buildroot}/opt/${{ env.APP_NAME }}
          cp -r ../SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}/* %{buildroot}/opt/${{ env.APP_NAME }}/
          
          mkdir -p %{buildroot}/usr/share/applications
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.desktop %{buildroot}/usr/share/applications/
          
          mkdir -p %{buildroot}/usr/share/icons/hicolor/128x128/apps
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.png %{buildroot}/usr/share/icons/hicolor/128x128/apps/

          %files
          /opt/${{ env.APP_NAME }}
          /usr/share/applications/gozen.desktop
          /usr/share/icons/hicolor/128x128/apps/gozen.png
          EOF

          # Build
          rpmbuild -bb rpmbuild/SPECS/${{ env.APP_NAME }}.spec

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_RPM_v${{ inputs.version }}
          path: rpmbuild/RPMS/x86_64/*.rpm
