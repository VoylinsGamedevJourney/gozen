name: GoZen release build
on:
  workflow_dispatch:
    inputs:
      version:
        description: GoZen version number
        type: string
        default: '0.5.1-alpha'
      godot_version:
        description: The Godot version to use
        type: string
        default: '4.5.1-stable'

env:
  APP_NAME: gozen
  PATH_FFMPEG_LINUX: core/ffmpeg/bin_linux
  PATH_FFMPEG_WINDOWS: core/ffmpeg/bin_windows
  EXPORT_PATH_LINUX: bin/linux_x86_64
  EXPORT_PATH_WINDOWS: bin/windows_x86_64

run-name: 'Build GoZen Release: v${{ inputs.version }} by @${{ github.actor }}'

jobs:
# Start FFMPEG
  ffmpeg-compile-linux-x86_64:
    name: Compile FFmpeg - Linux x86_64
    runs-on: ubuntu-22.04
    steps:
      - name: Installing dependencies
        run: |
          sudo add-apt-repository ppa:git-core/ppa
          sudo apt update

          sudo apt-get install -y git git-svn bash yasm nasm python3 python3-pip scons gcc diffutils make wget unzip tar \
          cmake autoconf automake libtool ninja-build pkg-config \
          binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu \
          libnuma-dev fuse libfuse2 desktop-file-utils patchelf

      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile FFmpeg
        run: |
          export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
          python -m core.build_ffmpeg --platform linux --arch x86_64 --threads 4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg_linux_x86_64
          path: ${{ env.PATH_FFMPEG_LINUX }}
          retention-days: 1

  ffmpeg-compile-windows-x86_64:
    name: Compile FFmpeg - Windows x86_64
    needs: ffmpeg-build-windows-deps
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-windows-build-env

      - name: Download all dependencies
        uses: actions/download-artifact@v4
        with:
          pattern: dep_win_x86_64_*
          path: ${{ env.PATH_FFMPEG_WINDOWS }}
          merge-multiple: true

      - name: Compile FFmpeg
        working-directory: ./core
        run: python3 -c "import sys; sys.path.append('.'); import build_ffmpeg; build_ffmpeg.build_ffmpeg_windows('x86_64', 4, {})"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg_windows_x86_64
          path: ${{ env.PATH_FFMPEG_WINDOWS }}
          retention-days: 1

  ffmpeg-build-windows-deps:
    name: FFmpeg - Windows dependency ${{ matrix.dep }}
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        dep: [x264, x265, aom, svt_av1, vpx, opus, ogg_vorbis, mp3lame]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-windows-build-env

      - name: Build ${{ matrix.dep }}
        uses: ./.github/actions/build-ffmpeg-dep
        with:
          dep_name: ${{ matrix.dep }}
          arch: x86_64

      - uses: actions/upload-artifact@v4
        with:
          name: dep_win_x86_64_${{ matrix.dep }}
          path: core/ffmpeg/bin_windows
          retention-days: 1
# End FFMPEG

# Start GDExtension
  build-gde-linux:
    name: Build Linux GDE (${{ matrix.target }})
    runs-on: ubuntu-22.04
    needs: ffmpeg-compile-linux-x86_64
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            target: template_debug
            scons_flags: platform=linux arch=x86_64
          - platform: linux
            target: template_release
            scons_flags: platform=linux arch=x86_64
    steps:
      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setting up environment.
      - name: Setup Linux dependencies
        uses: ./.github/actions/setup-linux-deps

      # Fetch FFmpeg.
      - name: Download FFmpeg
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg_linux_x86_64
          path: ${{ env.PATH_FFMPEG_LINUX }}

      # Compile.
      - name: Compile GDE
        working-directory: ./core
        run: scons -j$(nproc) target=${{ matrix.target }} platform=linux arch=x86_64
        
      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_gde_${{ matrix.target }}_x86_64
          path: bin/linux_x86_64
          retention-days: 1

  build-gde-windows:
    name: Build Windows GDE (${{ matrix.target }})
    runs-on: windows-latest
    needs: ffmpeg-compile-windows-x86_64
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: template_debug
          - target: template_release
    steps:
      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setting up environment.
      - name: Setup Windows dependencies
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-scons mingw-w64-ucrt-x86_64-python make

      # Download FFmpeg.
      - name: Download FFmpeg
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg_windows_x86_64
          path: ${{ env.PATH_FFMPEG_WINDOWS }}

      # Compile.
      - name: Compile GDE
        working-directory: ./core
        run: scons -j$(nproc) target=${{ matrix.target }} platform=windows arch=x86_64 use_static_cpp=yes use_mingw=yes
        
      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows_gde_${{ matrix.target }}_x86_64
          path: bin/windows_x86_64
          retention-days: 1
# End GDExtension

# Start GoZen build
  export-gozen-linux:
    name: Export linux
    needs: build-gde-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-linux-deps
      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ inputs.godot_version }}
          os: linux

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_debug_x86_64
          path: ${{ env.EXPORT_PATH_LINUX }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_release_x86_64
          path: ${{ env.EXPORT_PATH_LINUX }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Prepare & export
        working-directory: ./src
        run: |
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot

          mkdir -p ../${{ env.EXPORT_PATH_LINUX }}
          export LD_LIBRARY_PATH=$(readlink -f ../${{ env.EXPORT_PATH_LINUX }}):$LD_LIBRARY_PATH
          ls -l ../${{ env.EXPORT_PATH_LINUX }}

          godot --import godot.project --headless --quit
          godot --headless --export-release "Linux_x86_64" ../${{ env.EXPORT_PATH_LINUX }}/${{ env.APP_NAME }}.x86_64

      - name: Cleanup & fix RPATH
        working-directory: ${{ env.EXPORT_PATH_LINUX }}
        run: |
          rm -f *template_debug* 
          chmod +x ${{ env.APP_NAME }}.x86_64
          patchelf --set-rpath '$ORIGIN' ${{ env.APP_NAME }}.x86_64
          find . -name "*.so" -exec patchelf --set-rpath '$ORIGIN' {} \;

      - name: Upload raw Linux export
        uses: actions/upload-artifact@v4
        with:
          name: export_linux
          path: ${{ env.EXPORT_PATH_LINUX }}

  export-gozen-windows:
    name: Export Windows
    needs: build-gde-windows
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git zip unzip mingw-w64-ucrt-x86_64-gcc

      - name: Download rcedit
        shell: bash
        run: |
          curl -L -o rcedit.exe https://github.com/electron/rcedit/releases/download/v2.0.0/rcedit-x64.exe
          mkdir -p /c/Program\ Files/Godot
          mv rcedit.exe /c/Program\ Files/Godot/rcedit.exe

      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ inputs.godot_version }}
          os: windows

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_debug_x86_64
          path: ${{ env.EXPORT_PATH_WINDOWS }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: windows_gde_template_release_x86_64
          path: ${{ env.EXPORT_PATH_WINDOWS }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Configure Godot rcedit path
        shell: bash
        run: |
          export PATH=$PATH:"/c/Program Files/Godot"
          godot --headless --quit
          echo 'export/windows/rcedit = "C:/Program Files/Godot/rcedit.exe"' >> src/export_presets.cfg

      - name: Export Windows
        working-directory: ./src
        run: |
          export PATH=$PATH:"/c/Program Files/Godot":"$(pwd)/../${{ env.EXPORT_PATH_WINDOWS }}"
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot
          mkdir -p ../${{ env.EXPORT_PATH_WINDOWS }}
          godot --import godot.project --headless --quit
          godot --headless --export-release "Windows_x86_64" ../${{ env.EXPORT_PATH_WINDOWS }}/GoZen.exe

      - name: Bundle Windows
        working-directory: ${{ env.EXPORT_PATH_WINDOWS }}
        run: |
          cp ../../LICENSE .
          cp ../../MANUAL.md .
          zip -r "GoZen_Windows_v${{ inputs.version }}.zip" *

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_Windows_v${{ inputs.version }}
          path: ${{ env.EXPORT_PATH_WINDOWS }}/GoZen_Windows_v${{ inputs.version }}.zip 
        
  package-gozen-appimage:
    name: Package AppImage
    needs: export-gozen-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin
          merge-multiple: true

      - name: Get dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get install libfuse2

      - name: Build AppImage
        run: |
          APP_DIR=AppDir
          mkdir -p $APP_DIR/usr/{bin,lib,share/applications,share/icons/hicolor/128x128/apps}
          
          cp bin/${{ env.APP_NAME }}.x86_64 $APP_DIR/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $APP_DIR/usr/lib/
          cp assets/linux/gozen.png $APP_DIR/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png
          cp assets/linux/gozen.png $APP_DIR/.DirIcon
          cp assets/linux/gozen.desktop $APP_DIR/usr/share/applications/
          
          cat <<EOF > $APP_DIR/AppRun
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\${0}")")"
          export LD_LIBRARY_PATH="\$HERE/usr/lib:\$LD_LIBRARY_PATH"
          exec "\$HERE/usr/bin/${{ env.APP_NAME }}" "\$@"
          EOF
          chmod +x $APP_DIR/AppRun $APP_DIR/usr/bin/${{ env.APP_NAME }}

          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage
          
          ./linuxdeploy-x86_64.AppImage --appdir $APP_DIR --output appimage

          # Rename
          mv GoZen*.AppImage ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_AppImage_v${{ inputs.version }}
          path: ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

  package-gozen-deb:
    name: Package DEB
    needs: export-gozen-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin
          merge-multiple: true
      
      - name: Build DEB
        run: |
          DEB_ROOT=deb_dist
          mkdir -p $DEB_ROOT/{DEBIAN,usr/bin,usr/lib/${{ env.APP_NAME }},usr/share/applications,usr/share/icons/hicolor/128x128/apps}

          cp bin/${{ env.APP_NAME }}.x86_64 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $DEB_ROOT/usr/lib/${{ env.APP_NAME }}/
          cp assets/linux/gozen.desktop $DEB_ROOT/usr/share/applications/
          cp assets/linux/gozen.png $DEB_ROOT/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png

          chmod 755 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}

          cat <<EOF > $DEB_ROOT/DEBIAN/control
          Package: ${{ env.APP_NAME }}
          Version: ${{ inputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.27)
          Maintainer: Voylin <noreply@example.com>
          Description: GoZen Video Editor
           A fast and modern open-source video editor for Linux.
          EOF

          dpkg-deb --build $DEB_ROOT ${{ env.APP_NAME }}_v${{ inputs.version }}_amd64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_DEB_v${{ inputs.version }}
          path: "*.deb"

  package-gozen-rpm:
    name: Package RPM
    needs: export-gozen-linux
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: export_linux
          path: bin
          merge-multiple: true
      
      - name: Install RPM tools
        run: sudo apt-get install -y rpm

      - name: Build RPM
        run: |
          VERSION=$(echo "${{ inputs.version }}" | tr '-' '_')
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          SRC_DIR=rpmbuild/SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}
          mkdir -p $SRC_DIR
          cp bin/* $SRC_DIR/
          cp assets/linux/gozen.desktop $SRC_DIR/
          cp assets/linux/gozen.png $SRC_DIR/
          
          sed -i 's|^Exec=.*|Exec=/opt/${{ env.APP_NAME }}/${{ env.APP_NAME }}.x86_64|' $SRC_DIR/gozen.desktop

          cat <<EOF > rpmbuild/SPECS/${{ env.APP_NAME }}.spec
          %define _topdir $(pwd)/rpmbuild
          Name:           ${{ env.APP_NAME }}
          Version:        $VERSION
          Release:        1
          Summary:        GoZen Video Editor
          License:        GPLv3
          BuildArch:      x86_64
          
          %description
          GoZen Video Editor.

          %install
          mkdir -p %{buildroot}/opt/${{ env.APP_NAME }}
          cp -r ../SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}/* %{buildroot}/opt/${{ env.APP_NAME }}/
          
          mkdir -p %{buildroot}/usr/share/applications
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.desktop %{buildroot}/usr/share/applications/
          
          mkdir -p %{buildroot}/usr/share/icons/hicolor/128x128/apps
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.png %{buildroot}/usr/share/icons/hicolor/128x128/apps/

          %files
          /opt/${{ env.APP_NAME }}
          /usr/share/applications/gozen.desktop
          /usr/share/icons/hicolor/128x128/apps/gozen.png
          EOF

          # Build
          rpmbuild -bb rpmbuild/SPECS/${{ env.APP_NAME }}.spec

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_RPM_v${{ inputs.version }}
          path: rpmbuild/RPMS/x86_64/*.rpm
# End GoZen build
