name: GoZen Linux release build
on:
  workflow_dispatch:
    inputs:
      version:
        description: GoZen version number
        type: string
        default: '0.6.2-alpha'
      godot_version:
        description: The Godot version to use
        type: string
        default: '4.6-stable'

env:
  APP_NAME: gozen
  PATH_FFMPEG: core/ffmpeg/bin_linux
  PATH_EXPORT: bin/linux_x86_64

run-name: 'Build GoZen Linux Release: v${{ inputs.version }} by @${{ github.actor }}'

jobs:
# Start FFMPEG build
  ffmpeg-compile-x86_64:
    name: Compile FFmpeg - Linux x86_64
    runs-on: ubuntu-22.04
    steps:
      - name: Installing dependencies
        run: |
          sudo add-apt-repository ppa:git-core/ppa
          sudo apt update

          sudo apt-get install -y git git-svn bash yasm nasm python3 python3-pip scons gcc diffutils make wget unzip tar \
          cmake autoconf automake libtool ninja-build pkg-config \
          binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu \
          libnuma-dev fuse libfuse2 desktop-file-utils patchelf

      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Compile FFmpeg
        run: |
          export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH
          python -m core.build_ffmpeg --platform linux --arch x86_64 --threads 4

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg_linux_x86_64
          path: ${{ env.PATH_FFMPEG }}
          retention-days: 1
# End FFMPEG

# Start GDExtension
  build-gde:
    name: Build Linux GDE (${{ matrix.target }})
    runs-on: ubuntu-22.04
    needs: ffmpeg-compile-x86_64
    defaults:
      run:
        shell: bash
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            target: template_debug
            scons_flags: platform=linux arch=x86_64
          - platform: linux
            target: template_release
            scons_flags: platform=linux arch=x86_64
    steps:
      - name: Checkout submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # Setting up environment.
      - name: Setup Linux dependencies
        uses: ./.github/actions/setup-linux-deps

      # Fetch FFmpeg.
      - name: Download FFmpeg
        uses: actions/download-artifact@v4
        with:
          name: ffmpeg_linux_x86_64
          path: ${{ env.PATH_FFMPEG }}

      # Compile.
      - name: Compile GDE
        working-directory: ./core
        run: scons -j$(nproc) target=${{ matrix.target }} platform=linux arch=x86_64

      # Upload
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux_gde_${{ matrix.target }}_x86_64
          path: bin/linux_x86_64
          retention-days: 1
# End GDExtension

# Start GoZen build
  export-gozen:
    name: Export linux
    needs: build-gde
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: ./.github/actions/setup-linux-deps
      - uses: ./.github/actions/setup-godot
        with:
          godot-version: ${{ inputs.godot_version }}
          os: linux

      - name: Fetch GDE libs (debug)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_debug_x86_64
          path: ${{ env.PATH_EXPORT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Fetch GDE libs (release)
        uses: actions/download-artifact@v4
        with:
          name: linux_gde_template_release_x86_64
          path: ${{ env.PATH_EXPORT }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          merge-multiple: true

      - name: Prepare & export
        working-directory: ./src
        run: |
          sed -i 's|^config/version\s*=.*|config/version="${{ inputs.version }}"|' project.godot

          mkdir -p ../${{ env.PATH_EXPORT }}
          export LD_LIBRARY_PATH=$(readlink -f ../${{ env.PATH_EXPORT }}):$LD_LIBRARY_PATH
          ls -l ../${{ env.PATH_EXPORT }}

          godot --import godot.project --headless --quit
          godot --headless --export-release "Linux_x86_64" ../${{ env.PATH_EXPORT }}/${{ env.APP_NAME }}.x86_64

      - name: Cleanup & fix RPATH
        working-directory: ${{ env.PATH_EXPORT }}
        run: |
          rm -f *template_debug*
          chmod +x ${{ env.APP_NAME }}.x86_64
          patchelf --set-rpath '$ORIGIN' ${{ env.APP_NAME }}.x86_64
          find . -name "*.so" -exec patchelf --set-rpath '$ORIGIN' {} \;

      - name: Upload raw Linux export
        uses: actions/upload-artifact@v4
        with:
          name: GoZen_Linux_v${{ inputs.version }}
          path: ${{ env.PATH_EXPORT }}

  package-gozen-appimage:
    name: Package AppImage
    needs: export-gozen
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: GoZen_Linux_v${{ inputs.version }}
          path: bin
          merge-multiple: true

      - name: Get dependencies
        run: |
          sudo add-apt-repository universe
          sudo apt-get install libfuse2

      - name: Build AppImage
        run: |
          APP_DIR=AppDir
          mkdir -p $APP_DIR/usr/{bin,lib,share/applications,share/icons/hicolor/128x128/apps}

          cp bin/${{ env.APP_NAME }}.x86_64 $APP_DIR/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $APP_DIR/usr/lib/
          cp assets/linux/gozen.png $APP_DIR/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png
          cp assets/linux/gozen.png $APP_DIR/.DirIcon
          cp assets/linux/gozen.desktop $APP_DIR/usr/share/applications/

          cat <<EOF > $APP_DIR/AppRun
          #!/bin/bash
          HERE="\$(dirname "\$(readlink -f "\${0}")")"
          export LD_LIBRARY_PATH="\$HERE/usr/lib:\$LD_LIBRARY_PATH"
          exec "\$HERE/usr/bin/${{ env.APP_NAME }}" "\$@"
          EOF
          chmod +x $APP_DIR/AppRun $APP_DIR/usr/bin/${{ env.APP_NAME }}

          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          ./linuxdeploy-x86_64.AppImage --appdir $APP_DIR --output appimage

          # Rename
          mv GoZen*.AppImage ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_AppImage_v${{ inputs.version }}
          path: ${{ env.APP_NAME }}-v${{ inputs.version }}-x86_64.AppImage

  package-gozen-deb:
    name: Package DEB
    needs: export-gozen
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: GoZen_Linux_v${{ inputs.version }}
          path: bin
          merge-multiple: true

      - name: Build DEB
        run: |
          DEB_ROOT=deb_dist
          mkdir -p $DEB_ROOT/{DEBIAN,usr/bin,usr/lib/${{ env.APP_NAME }},usr/share/applications,usr/share/icons/hicolor/128x128/apps}

          cp bin/${{ env.APP_NAME }}.x86_64 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}
          cp bin/*.so* $DEB_ROOT/usr/lib/${{ env.APP_NAME }}/
          cp assets/linux/gozen.desktop $DEB_ROOT/usr/share/applications/
          cp assets/linux/gozen.png $DEB_ROOT/usr/share/icons/hicolor/128x128/apps/${{ env.APP_NAME }}.png

          chmod 755 $DEB_ROOT/usr/bin/${{ env.APP_NAME }}

          cat <<EOF > $DEB_ROOT/DEBIAN/control
          Package: ${{ env.APP_NAME }}
          Version: ${{ inputs.version }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libc6 (>= 2.27)
          Maintainer: Voylin <noreply@example.com>
          Description: GoZen Video Editor
           A fast and modern open-source video editor for Linux.
          EOF

          dpkg-deb --build $DEB_ROOT ${{ env.APP_NAME }}_v${{ inputs.version }}_amd64.deb

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_DEB_v${{ inputs.version }}
          path: "*.deb"

  package-gozen-rpm:
    name: Package RPM
    needs: export-gozen
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: GoZen_Linux_v${{ inputs.version }}
          path: bin
          merge-multiple: true

      - name: Install RPM tools
        run: sudo apt-get install -y rpm

      - name: Build RPM
        run: |
          VERSION=$(echo "${{ inputs.version }}" | tr '-' '_')
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          SRC_DIR=rpmbuild/SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}
          mkdir -p $SRC_DIR
          cp bin/* $SRC_DIR/
          cp assets/linux/gozen.desktop $SRC_DIR/
          cp assets/linux/gozen.png $SRC_DIR/

          sed -i 's|^Exec=.*|Exec=/opt/${{ env.APP_NAME }}/${{ env.APP_NAME }}.x86_64|' $SRC_DIR/gozen.desktop

          cat <<EOF > rpmbuild/SPECS/${{ env.APP_NAME }}.spec
          %define _topdir $(pwd)/rpmbuild
          Name:           ${{ env.APP_NAME }}
          Version:        $VERSION
          Release:        1
          Summary:        GoZen Video Editor
          License:        GPLv3
          BuildArch:      x86_64

          %description
          GoZen Video Editor.

          %install
          mkdir -p %{buildroot}/opt/${{ env.APP_NAME }}
          cp -r ../SOURCES/${{ env.APP_NAME }}-${{ inputs.version }}/* %{buildroot}/opt/${{ env.APP_NAME }}/

          mkdir -p %{buildroot}/usr/share/applications
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.desktop %{buildroot}/usr/share/applications/

          mkdir -p %{buildroot}/usr/share/icons/hicolor/128x128/apps
          mv %{buildroot}/opt/${{ env.APP_NAME }}/gozen.png %{buildroot}/usr/share/icons/hicolor/128x128/apps/

          %files
          /opt/${{ env.APP_NAME }}
          /usr/share/applications/gozen.desktop
          /usr/share/icons/hicolor/128x128/apps/gozen.png
          EOF

          # Build
          rpmbuild -bb rpmbuild/SPECS/${{ env.APP_NAME }}.spec

      - uses: actions/upload-artifact@v4
        with:
          name: GoZen_RPM_v${{ inputs.version }}
          path: rpmbuild/RPMS/x86_64/*.rpm
# End GoZen build
